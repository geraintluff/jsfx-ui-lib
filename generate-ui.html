<!DOCTYPE html>
<html>
	<head>
		<title>JSFX Transform</title>
	</head>
	<body>
		<h2>To use:</h2>
		<ol>
			<li>Place <a href="https://raw.githubusercontent.com/geraintluff/jsfx-ui-lib/master/ui-lib.jsfx-inc">ui-lib.jsfx-inc</a> in the same directory as your effect
			<li>Add:<pre><code>import "ui-lib.jsfx-inc"</code></pre>to your header (e.g. underneath the sliders)
			<li>Allocate the UI library some of the memory buffer in <code>@init</code>, e.g.
<pre>@init
freemem = 0; // some empty section of memory
freemem = ui_setup(freemem); // it returns the end of its allocated buffer</pre>
			<li>Paste your code (or just the headers) below, with these annotations:
				<ul>
					<dt><code>// ui:row</code></dt><dd>starts a new row</dd>
					<dt><code>// ui:group</code></dt><dd>starts a new group (within a row)</dd>
					<dt><code>// ui:group name=Some Name</code></dt><dd>gives your group a name</dd>
				</ul>
			<li>Click "Generate"
			<li>Copy the generated code displayed below
		</ol>
		<textarea id="input" style="width:100%; height: 20em;">
slider1:sinput=0<0,64,1{Velocity,Pitch,0 Bank Sel M,1 Mod Wheel M,2 Breath M,3,4 Foot P M,5 Porta M,6 Data Entry M,7 Vol M,8 Balance M,9,10 Pan M,11 Expression M,12 Ctrl 1 M,13 Ctrl 2 M,14,15,16 GP Slider 1,17 GP Slider 2,18 GP Slider 3,19 GP Slider 4,20,21,22,23,24,25,26,27,28,29,30,31,64 Hold P sw,65 Porta sw,66 Sustenuto sw,67 Soft P sw,68 Legato P sw,69 Hold 2 P sw,70 S.Variation,71 S.Timbre,72 S.Release,73 S.Attack,74 S.Brightness,75 S.Ctrl 6,76 S.Ctrl 7,77 S.Ctrl 8,78 S.Ctrl 9,79 S.Ctrl 10,80 GP B.1 sw,81 GP B.2 sw,82 GP B.3 sw,83 GP B.4 sw,84,85,86,87,88,89,90,91 Effects Lv,92 Trem Lv,93 Chorus Lv,94 Celeste Lv,95 Phaser Lv}>Input
slider2:soutput=21<0,63,1{0 Bank Sel M,1 Mod Wheel M,2 Breath M,3,4 Foot P M,5 Porta M,6 Data Entry M,7 Vol M,8 Balance M,9,10 Pan M,11 Expression M,12 Ctrl 1 M,13 Ctrl 2 M,14,15,16 GP Slider 1,17 GP Slider 2,18 GP Slider 3,19 GP Slider 4,20,21,22,23,24,25,26,27,28,29,30,31,64 Hold P sw,65 Porta sw,66 Sustenuto sw,67 Soft P sw,68 Legato P sw,69 Hold 2 P sw,70 S.Variation,71 S.Timbre,72 S.Release,73 S.Attack,74 S.Brightness,75 S.Ctrl 6,76 S.Ctrl 7,77 S.Ctrl 8,78 S.Ctrl 9,79 S.Ctrl 10,80 GP B.1 sw,81 GP B.2 sw,82 GP B.3 sw,83 GP B.4 sw,84,85,86,87,88,89,90,91 Effects Lv,92 Trem Lv,93 Chorus Lv,94 Celeste Lv,95 Phaser Lv}>CC Output
slider3:schanout=1<0,16,1{All,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16}>MIDI Output Channel
slider5:scurve=0<0,1,1{Bezier curve,Step}>Curve type
// ui:row
slider7:sp0=0<0,1,0.001>-Range Limit 1 (unit)
slider8:sp2=1<0,1,0.001>-Range Limit 2
// ui:row
slider10:sp1x=0.5<0,1>-Control X
slider11:sp1y=0.5<0,1>-Control Y
// ui:group name=foo
slider13:ends=0<0,3,1{Off,Hold upper and lower values,Hold upper value only,Hold lower value only}>-End Conditions
slider16:sclass=0<0,3,1{None,Master,Slave}>Class
slider17:sgroup=0<0,15,1{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16}>Class Group
		</textarea>
		<button id="translate-button" style="width:100%;font-size:1.2em;">Generate</button>
		<pre id="output" style="border: 1px solid grey; background-color: #EEE; padding: 1em;"></pre>
		<script>
			function uiFromHeader(headerText) {
				function parseLayout(headerText) {
					var currentGroup = {name: null, controls: []};
					var currentRow = [currentGroup];
					var rows = [currentRow];

					var sliderOptions = {};

					function addSlider(line) {
						// Functions that match inputs on the front of the text, and remove them
						// Whitespace is ignored/stripped
						function consumeExact(exact) {
							line = line.trim();
							if (line.substr(0, exact.length) !== exact) {
								throw new Error('Expected ' + JSON.stringify(exact));
							}
							line = line.substr(exact.length).trim();
						}
						function consumeMatch(regex) {
							line = line.trim();
							var match = line.match(regex);
							if (!match) return null;
							var result = match[0];
							line = line.substr(result.length).trim();
							return result.trim();
						}
						function consumeNumber() {
							return consumeMatch(/^[0-9\.]*/);
						}

						var sliderVar = consumeMatch(/^slider[0-9]+/);
						consumeExact(':');

						if (/^[^<]+\=/.test(line)) {
							sliderVar = consumeMatch(/^[^=]+/);
							consumeExact('=');
						}

						var defaultValue = consumeNumber();
						consumeExact('<');
						var low = consumeNumber();
						consumeExact(',');
						var high = consumeNumber();
						var step = 0, optionNames = null;
						if (line[0] == ',') {
							consumeExact(',');
							var step = consumeNumber();

							if (line[0] == '{') {
								consumeExact('{');
								var optionText = consumeMatch(/^[^}]*/);
								optionNames = optionText.split(',');
								consumeExact('}');
							}
						}
						consumeExact('>');
						var sliderTitle = line;
						var hidden = false;
						if (sliderTitle[0] == '-') {
							hidden = true;
							sliderTitle = sliderTitle.substr(1);
						}

						var sliderObj = {
							name: sliderVar,
							start: defaultValue,
							low: low,
							high: high,
							step: step,
							optionNames: optionNames,
							hidden: hidden,
							title: sliderTitle,
							config: sliderOptions
						};
						currentGroup.controls.push(sliderObj);

						sliderOptions = {};
					}
					function parseOptions(line) {
						var optionsObj = {};
						var keywordMatch = line.match(/^\s*ui\:([^\s]+)(.*)/i);
						if (keywordMatch) {
							line = keywordMatch[2];
							var keyword = keywordMatch[1];

							if (keyword === 'row') {
								if (currentRow.length > 1 ||  currentRow[0].controls.length) {
									currentGroup = {name: null, controls: []};
									currentRow = [currentGroup];
									rows.push(currentRow);
								}
							}
							if (keyword === 'group') {
								if (currentGroup.controls.length) {
									currentGroup = optionsObj = {name: null, controls: []};
									currentRow.push(currentGroup);
								}
							}
							if (keyword === 'control') {
								optionsObj = sliderOptions;
							}
						}

						var components = line.split(',');
						components.forEach(function(pair) {
							var key = pair.split('=', 1)[0];
							var value = pair.substr(key.length + 1);
							key = key.toLowerCase().trim();
							if (key) {
								optionsObj[key] = value.trim();
							}
						});
					}

					headerText.split('\n').forEach(function (line) {
						line = line.trim();
						if (/^slider[0-9]+\:/.test(line)) {
							addSlider(line);
						}
						if (/^\/\//.test(line)) {
							parseOptions(line.substr(2));
						}
					});

					return rows;
				}

				function layoutToJsfx(layout) {
					function indent(code) {
						return '\t' + code.replace(/\n$/, '').split('\n').join('\n\t') + '\n';
					}

					var code = '@gfx 640 500\n\n';
					code += 'function layout_control_title(title) local(h) (\n'
						+ indent('h = max((ui_height() - 60)/2, ui_height()*0.2);')
						+ indent('ui_split_top(h);')
						+ indent(indent('ui_align(0.5, 1);'))
						+ indent(indent('ui_text(title);'))
						+ indent('ui_pop();')
						+ ');\n';
					code += 'function layout_control_value(value, format) local(h) (\n'
						+ indent('h = max((ui_height() - 60)/2, ui_height()*0.3);')
						+ indent('ui_split_bottom(h);')
						+ indent(indent('ui_align(0.5, 1);'))
						+ indent(indent('value = control_hidden_textnumber(value, value*1.00000001, format);'))
						+ indent('ui_pop();')
						+ indent('value;')
						+ ');\n';
					code += 'ui_start("main");\n\n';
					code += 'ui_screen() === "main" ? (\n';
					code += indent('ui_split_topratio(1/' + layout.length + ');');
					code += layout.map(function (row) {
						var totalControls = 0;
						row.forEach(function (group) {
							totalControls += group.controls.length;
						});
						var remainingControls = totalControls;
						var code = '';
						row.forEach(function (group) {
							code += 'ui_split_leftratio(' + group.controls.length + '/' + remainingControls + ');\n';
							remainingControls -= group.controls.length;
							if (group.name) {
								code += indent('control_group(' + JSON.stringify(group.name) + ');');
							} else {
								code += indent('control_group(-1);');
							}
							code += indent('ui_split_leftratio(1/' + group.controls.length + ');');
							code += group.controls.map(function (control) {
								var title = control.title;
								var displayFormat = "%.3f";
								var unitMatch = title.match(/^(.*)\((.*)\)\s*$/);
								if (unitMatch) {
									title = unitMatch[1];
									displayFormat += ' ' + unitMatch[2];
								}
								title = title.replace(/^\s+|\s+$/g, '');
								displayFormat = displayFormat.replace(/^\s+|\s+$/g, '');
								control.config.format = control.config.format || displayFormat;
								var code = 'layout_control_title(' + JSON.stringify(title) + ');\n';
								return code + controlToJsfx(control);
							}).map(indent).map(indent).join(indent('ui_split_next();'));
							code += indent('ui_pop();');
							code += 'ui_pop();\n';
						});
						return code;
					}).map(indent).map(indent).join(indent('ui_split_next();'));
					code += indent('ui_pop();');
					code += ') : control_system();\n';
					return code + '\n/*' + JSON.stringify(layout, null, '\t') + '*/\n';
code;
				}

				var layout = parseLayout(headerText);
				return layoutToJsfx(layout);
			}

			function controlToJsfx(control) {
				var code = control.name + ' = layout_control_value(' + control.name + ', ' + JSON.stringify(control.config.format) + ');\n';
				return code;
			}

			function translate() {
				var headerText = document.getElementById('input').value;
				var jsfx;
				try {
					jsfx = uiFromHeader(headerText);
				} catch (e) {
					jsfx = e.stack || e.message;
				}
				var pre = document.getElementById('output');
				pre.innerHTML = '';
				pre.appendChild(document.createTextNode(jsfx));
			}
			document.getElementById('translate-button').onclick = translate;
			translate();
		</script>
	</body>
</html>
